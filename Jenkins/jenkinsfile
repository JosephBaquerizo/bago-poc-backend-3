pipeline {
  environment{
    USER_CREDENTIAL = credentials('dockerhublogin-bago')
    DOCKER_REPOSITORY = 'https://registry.hub.docker.com'
    HELM_REPOSITORY = 'helm-internal'
    PROJECT_NAME = 'backbagoimage'
    DEPLOY_CONTEXT = '/msBagoBackend/'
    PROJECT_VERSION = 'latest'
    docker = tool 'docker2'
    dockerimagename = 'josanbaq7/backbagoimage:latest'
  }
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        metadata:
          labels:
            app: test
        spec:
          hostAliases:
          - ip: "192.168.5.67"
            hostnames:
              - "nexusdev.krugercorp.com"
          - ip: "192.168.5.67"
            hostnames:
              - "dockerdev.krugercorp.com"
          containers:
          - name: node
            env:
              - name: 'HOME'
                value: '.'
            image: node:16.17.0-alpine3.16
            command:
            - cat
            tty: true
          - name: docker
            image: docker:24.0.0-cli-alpine3.18
            command:
            - cat
            tty: true
            volumeMounts:
            - mountPath: /var/run/docker.sock
              name: docker-sock
          - name: helm
            image: alpine/helm:3.10.0
            command:
            - cat
            tty: true
          volumes:
          - name: docker-sock
            hostPath:
              path: /var/run/docker.sock
      '''
    }
  }
  stages {
    stage('SonarQube Analysis') {
        steps {
            script {
                def mvn = tool 'Maven';
                withSonarQubeEnv() {
                    sh "${mvn}/bin/mvn clean verify sonar:sonar -Dsonar.projectKey=bago-poc-backend -Dsonar.projectName='bago-poc-backend'"
                }
            }
        }
    }
    stage('Build and publish docker image') {
      when { expression { true } }
      steps {
        container('docker') {
          sh 'chmod 0777 /var/run/docker.sock'
          sh 'docker logout'
          sh 'cd $HOME'
          sh 'docker build . -t docker.io/josanbaq7/backbagoimage:latest --load'
        }
      }
    }
    stage('Push image') {
      steps {
        container('docker') {
          withCredentials([usernamePassword(credentialsId: 'dockerhublogin-bago', passwordVariable: 'DOCKER_HUB_PASSWORD', usernameVariable: 'DOCKER_HUB_USERNAME')]) {
            sh "docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD"
            sh "docker push $dockerimagename"
            sh "docker rmi $dockerimagename"
          }
        }
      }
    }
  }
}